<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de Plantas + Pickers</title>
<style>
body { font-family: Arial, sans-serif; background: #f0f0f5; padding: 20px; }
.container { max-width: 1400px; margin: auto; }
h1 { text-align: center; margin-bottom: 30px; }
.form-row { display: flex; flex-wrap: wrap; gap: 20px; }
.plant-form, .picker-form {
  background: white; padding: 20px; border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1); flex: 1; min-width: 300px;
  margin-bottom: 20px;
}
.pickers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr)); gap: 20px; }
label { display: block; margin-top: 10px; font-weight: bold; }
input, textarea, select { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 5px; }
button.add-btn {
  border: 1px solid #333; background: none; color: #333;
  padding: 5px 10px; margin-left: 10px; cursor: pointer; border-radius: 4px;
}
button.add-btn:hover { background: #f0f0f0; }
button.submit-btn {
  margin-top: 15px; padding: 10px 20px; background: #FF3A00;
  color: white; border: none; border-radius: 5px; cursor: pointer;
}
button.submit-btn:hover { background: #AB2202; }
.cuadrante-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; padding: 5px; border-radius: 4px; }
.cuadrante-item span { font-weight: bold; }

/* Modal chat */
#chatModal {
  display:none; position:fixed; top:10%; right:10%; width:350px; max-height:500px; 
  background:white; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.2); 
  flex-direction:column; z-index:1000; overflow:hidden;
}
#chatModalHeader { background:#FF3A00; color:white; padding:10px; font-weight:bold; display:flex; justify-content:space-between;}
#chatMessages { padding:10px; height:350px; overflow-y:auto; background:#f9f9f9;}
#chatInputContainer { display:flex; padding:10px; border-top:1px solid #ddd; }
#chatInputContainer input { flex:1; padding:8px; border-radius:5px; border:1px solid #ccc;}
#chatInputContainer button { margin-left:5px; padding:8px 12px; background:#FF3A00; color:white; border:none; border-radius:5px; cursor:pointer;}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

</head>
<body>
<div class="container">
<h1>Gestor de Plantas + Pickers</h1>

<div class="form-row">
<!-- FORMULARIOS DE PLANTAS -->
<div class="plant-form" id="plant1Form">
  <h2>Planta 1</h2>
  <label>Título</label><input id="p1_title" type="text">
  <label>Usuarios</label><textarea id="p1_users" rows="3"></textarea>
  <label>Mensaje genérico</label><textarea id="p1_msg" rows="2"></textarea>
  <label>Cuadrante <button class="add-btn" onclick="addCuadrante(1)">Añadir</button></label>
  <div id="p1_cuadrantes_container"><input type="text" class="cuadrante_input"></div>
  <button class="submit-btn" onclick="goToPlant(1)">Ver Planta 1</button>
</div>
<div class="plant-form" id="plant2Form">
  <h2>Planta 2</h2>
  <label>Título</label><input id="p2_title" type="text">
  <label>Usuarios</label><textarea id="p2_users" rows="3"></textarea>
  <label>Mensaje genérico</label><textarea id="p2_msg" rows="2"></textarea>
  <label>Cuadrante <button class="add-btn" onclick="addCuadrante(2)">Añadir</button></label>
  <div id="p2_cuadrantes_container"><input type="text" class="cuadrante_input"></div>
  <button class="submit-btn" onclick="goToPlant(2)">Ver Planta 2</button>
</div>
<div class="plant-form" id="plant3Form">
  <h2>Planta 3</h2>
  <label>Título</label><input id="p3_title" type="text">
  <label>Usuarios</label><textarea id="p3_users" rows="3"></textarea>
  <label>Mensaje genérico</label><textarea id="p3_msg" rows="2"></textarea>
  <label>Cuadrante <button class="add-btn" onclick="addCuadrante(3)">Añadir</button></label>
  <div id="p3_cuadrantes_container"><input type="text" class="cuadrante_input"></div>
  <button class="submit-btn" onclick="goToPlant(3)">Ver Planta 3</button>
</div>
</div>

<h2>Pickers Autónomos</h2>
<div class="pickers-grid">
<!-- PICKERS 1-4 -->
<div class="picker-form" id="picker1Form">
  <h3>Picker 1</h3>
  <label>Título</label><input id="picker1_title" type="text">
  <label>Mensaje genérico</label><textarea id="picker1_msg" rows="2"></textarea>
  <label>Cuadrante <button class="add-btn" onclick="addPickerCuadrante(1)">Añadir</button></label>
  <div id="picker1_cuadrantes_container">
    <input type="text" class="picker_input">
    <select class="picker_priority"><option>baja</option><option>media</option><option>alta</option></select>
  </div>
  <button class="submit-btn" onclick="goToPicker(1)">Ver Picker</button>
  <button class="submit-btn" onclick="openPickerChat(1)">Abrir Chat</button>
</div>

<div class="picker-form" id="picker2Form">
  <h3>Picker 2</h3>
  <label>Título</label><input id="picker2_title" type="text">
  <label>Mensaje genérico</label><textarea id="picker2_msg" rows="2"></textarea>
  <label>Cuadrante <button class="add-btn" onclick="addPickerCuadrante(2)">Añadir</button></label>
  <div id="picker2_cuadrantes_container">
    <input type="text" class="picker_input">
    <select class="picker_priority"><option>baja</option><option>media</option><option>alta</option></select>
  </div>
  <button class="submit-btn" onclick="goToPicker(2)">Ver Picker</button>
  <button class="submit-btn" onclick="openPickerChat(2)">Abrir Chat</button>
</div>

<div class="picker-form" id="picker3Form">
  <h3>Picker 3</h3>
  <label>Título</label><input id="picker3_title" type="text">
  <label>Mensaje genérico</label><textarea id="picker3_msg" rows="2"></textarea>
  <label>Cuadrante <button class="add-btn" onclick="addPickerCuadrante(3)">Añadir</button></label>
  <div id="picker3_cuadrantes_container">
    <input type="text" class="picker_input">
    <select class="picker_priority"><option>baja</option><option>media</option><option>alta</option></select>
  </div>
  <button class="submit-btn" onclick="goToPicker(3)">Ver Picker</button>
  <button class="submit-btn" onclick="openPickerChat(3)">Abrir Chat</button>
</div>

<div class="picker-form" id="picker4Form">
  <h3>Picker 4</h3>
  <label>Título</label><input id="picker4_title" type="text">
  <label>Mensaje genérico</label><textarea id="picker4_msg" rows="2"></textarea>
  <label>Cuadrante <button class="add-btn" onclick="addPickerCuadrante(4)">Añadir</button></label>
  <div id="picker4_cuadrantes_container">
    <input type="text" class="picker_input">
    <select class="picker_priority"><option>baja</option><option>media</option><option>alta</option></select>
  </div>
  <button class="submit-btn" onclick="goToPicker(4)">Ver Picker</button>
  <button class="submit-btn" onclick="openPickerChat(4)">Abrir Chat</button>
</div>
</div>

</div>

<!-- MODAL CHAT -->
<div id="chatModal">
  <div id="chatModalHeader">
    <span id="chatTitle">Chat Picker</span>
    <button onclick="closeChat()">X</button>
  </div>
  <div id="chatMessages"></div>
  <div id="chatInputContainer">
    <input id="chatInput" type="text" placeholder="Escribe un mensaje...">
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>

<script>
// Config Firebase
const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_DOMINIO.firebaseapp.com",
  projectId: "TU_PROJECT_ID",
  storageBucket: "TU_BUCKET.appspot.com",
  messagingSenderId: "TU_SENDER_ID",
  appId: "TU_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Sonido y notificación
const notificationSound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

function notifyUser(title, body) {
  if (Notification.permission === 'granted') {
    new Notification(title, {body});
    notificationSound.play();
  }
}

// Plantas
function addCuadrante(plantNum){
  const container = document.getElementById(`p${plantNum}_cuadrantes_container`);
  const input = document.createElement('input'); input.type='text'; input.placeholder='QU0000346545'; input.className='cuadrante_input';
  container.appendChild(input);
}
function goToPlant(plantNum){
  const title = document.getElementById(`p${plantNum}_title`).value;
  const users = document.getElementById(`p${plantNum}_users`).value;
  const msg = document.getElementById(`p${plantNum}_msg`).value;
  const cuadrantes = Array.from(document.querySelectorAll(`#p${plantNum}_cuadrantes_container .cuadrante_input`))
      .map(i => i.value).filter(v => v);
  const data = { title, users, msg, cuadrantes: cuadrantes.join(',') };
  const plantUrls = {1:'first.html',2:'second.html',3:'third.html'};
  const url = plantUrls[plantNum];
  if(url) window.open(`${url}?${new URLSearchParams(data).toString()}`, '_blank');
}

// Pickers
function addPickerCuadrante(pickerNum){
  const container = document.getElementById(`picker${pickerNum}_cuadrantes_container`);
  const input = document.createElement('input'); input.type='text'; input.className='picker_input'; input.placeholder='QU0000346545';
  const select = document.createElement('select'); select.className='picker_priority';
  ['baja','media','alta'].forEach(p=>{ const o=document.createElement('option'); o.value=p; o.text=p; select.appendChild(o); });
  container.appendChild(input); container.appendChild(select);
}
function goToPicker(pickerNum){
  const title = document.getElementById(`picker${pickerNum}_title`).value;
  const msg = document.getElementById(`picker${pickerNum}_msg`).value;
  const inputs = document.querySelectorAll(`#picker${pickerNum}_cuadrantes_container .picker_input`);
  const selects = document.querySelectorAll(`#picker${pickerNum}_cuadrantes_container .picker_priority`);
  const data = Array.from(inputs).map((i,idx)=>i.value+'|'+selects[idx].value);
  window.open(`picker.html?${new URLSearchParams({title,msg,cuadrantes:data.join(',')}).toString()}`, '_blank');
}

// CHAT
let currentPicker = null;
let unsubscribe = null;

function openPickerChat(pickerNum){
  currentPicker = pickerNum;
  document.getElementById('chatTitle').innerText='Chat Picker '+pickerNum;
  document.getElementById('chatModal').style.display='flex';
  loadMessages();
}

function closeChat(){ 
  document.getElementById('chatModal').style.display='none'; 
  document.getElementById('chatMessages').innerHTML=''; 
  if(unsubscribe) unsubscribe(); unsubscribe=null;
}

function loadMessages(){
  if(!currentPicker) return;
  const chatContainer = document.getElementById('chatMessages');
  chatContainer.innerHTML='';
  unsubscribe = db.collection('pickers_chat').doc('picker_'+currentPicker)
    .collection('messages')
    .orderBy('timestamp')
    .onSnapshot(snapshot=>{
      chatContainer.innerHTML='';
      snapshot.forEach(doc=>{
        const msg = doc.data();
        const div = document.createElement('div');
        div.style.marginBottom='8px';
        div.innerHTML=`<b>${msg.user}:</b> ${msg.text}`;
        chatContainer.appendChild(div);
      });
      chatContainer.scrollTop=chatContainer.scrollHeight;
      // Notificación si mensaje reciente no es nuestro
      if(snapshot.docs.length>0){
        const last = snapshot.docs[snapshot.docs.length-1].data();
        if(last.user!=='Gestor') notifyUser(`Nuevo mensaje Picker ${currentPicker}`, last.text);
      }
    });
}

function sendMessage(){
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if(!text || !currentPicker) return;
  db.collection('pickers_chat').doc('picker_'+currentPicker).collection('messages').add({
    user:'Gestor',
    text:text,
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });
  input.value='';
}

// Solicitar permiso notificaciones al cargar
if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
  Notification.requestPermission();
}
</script>
</body>
</html>
