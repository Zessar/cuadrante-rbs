<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de Plantas + Pickers</title>
<style>
body { font-family: Arial, sans-serif; background: #f0f0f5; padding: 20px; }
.container { max-width: 1400px; margin: auto; }
h1 { text-align: center; margin-bottom: 30px; }

.form-row { display: flex; flex-wrap: wrap; gap: 20px; }
.plant-form, .picker-form {
  background: white; padding: 20px; border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1); flex: 1; min-width: 300px;
  margin-bottom: 20px;
}

label { display: block; margin-top: 10px; font-weight: bold; }
input, textarea, select { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 5px; }

button.add-btn {
  border: 1px solid #333; background: none; color: #333;
  padding: 5px 10px; margin-left: 10px; cursor: pointer; border-radius: 4px;
}
button.add-btn:hover { background: #f0f0f0; }

button.submit-btn {
  margin-top: 15px; padding: 10px 20px; background: #FF3A00;
  color: white; border: none; border-radius: 5px; cursor: pointer;
}
button.submit-btn:hover { background: #AB2202; }

/* GRID para pickers */
.pickers-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

/* CHAT MODAL */
#chatModal {
  display:none;
  position:fixed;
  top:10%;
  right:10%;
  width:350px;
  max-height:500px;
  background:white;
  border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.2);
  flex-direction:column;
  z-index:1000;
  overflow:hidden;
}
#chatModalHeader {
  background:#FF3A00; color:white; padding:10px; font-weight:bold; display:flex; justify-content:space-between;
}
#chatMessages { padding:10px; height:350px; overflow-y:auto; background:#f9f9f9; }
#chatInputContainer { display:flex; padding:10px; border-top:1px solid #ddd; }
#chatInput { flex:1; padding:8px; border-radius:5px; border:1px solid #ccc; }
#chatInputContainer button { margin-left:5px; padding:8px 12px; background:#FF3A00; color:white; border:none; border-radius:5px; cursor:pointer; }
</style>
</head>
<body>
<div class="container">
<h1>Gestor de Plantas + Pickers</h1>

<div class="form-row">
<!-- FORMULARIOS DE PLANTAS -->
<div class="plant-form" id="plant1Form">
  <h2>Planta 1</h2>
  <label>T√≠tulo</label>
  <input id="p1_title" type="text" placeholder="Ej: Cambiar de planta">

  <label>Usuarios (separados por comas)</label>
  <textarea id="p1_users" rows="3" placeholder="Usuario1, Usuario2"></textarea>

  <label>Mensaje gen√©rico</label>
  <textarea id="p1_msg" rows="2"></textarea>

  <label>Cuadrante
    <button type="button" class="add-btn" onclick="addCuadrante(1)">A√±adir</button>
  </label>
  <div id="p1_cuadrantes_container">
    <input type="text" class="cuadrante_input" placeholder="QU0000346545">
  </div>

  <button class="submit-btn" onclick="goToPlant(1)">Ver Planta 1</button>
</div>

<div class="plant-form" id="plant2Form">
  <h2>Planta 2</h2>
  <label>T√≠tulo</label>
  <input id="p2_title" type="text">
  <label>Usuarios (separados por comas)</label>
  <textarea id="p2_users" rows="3"></textarea>
  <label>Mensaje gen√©rico</label>
  <textarea id="p2_msg" rows="2"></textarea>
  <label>Cuadrante
    <button type="button" class="add-btn" onclick="addCuadrante(2)">A√±adir</button>
  </label>
  <div id="p2_cuadrantes_container">
    <input type="text" class="cuadrante_input">
  </div>
  <button class="submit-btn" onclick="goToPlant(2)">Ver Planta 2</button>
</div>

<div class="plant-form" id="plant3Form">
  <h2>Planta 3</h2>
  <label>T√≠tulo</label>
  <input id="p3_title" type="text">
  <label>Usuarios (separados por comas)</label>
  <textarea id="p3_users" rows="3"></textarea>
  <label>Mensaje gen√©rico</label>
  <textarea id="p3_msg" rows="2"></textarea>
  <label>Cuadrante
    <button type="button" class="add-btn" onclick="addCuadrante(3)">A√±adir</button>
  </label>
  <div id="p3_cuadrantes_container">
    <input type="text" class="cuadrante_input">
  </div>
  <button class="submit-btn" onclick="goToPlant(3)">Ver Planta 3</button>
</div>
</div>

<!-- FORMULARIOS PICKER AUT√ìNOMO -->
<h2>Pickers Aut√≥nomos</h2>
<div class="pickers-container">
<div class="picker-form" id="picker1Form">
  <h3>Picker 1</h3>
  <label>T√≠tulo</label><input id="picker1_title" type="text">
  <label>Mensaje gen√©rico</label><textarea id="picker1_msg" rows="2"></textarea>
  <label>Cuadrante
    <button class="add-btn" onclick="addPickerCuadrante(1)">A√±adir</button>
  </label>
  <div id="picker1_cuadrantes_container">
    <input type="text" class="picker_input">
    <select class="picker_priority">
      <option value="baja">Baja</option>
      <option value="media">Media</option>
      <option value="alta">Alta</option>
    </select>
  </div>
  <button class="submit-btn" onclick="goToPicker(1)">Ver Picker</button>
  <button class="submit-btn" onclick="openPickerChat(1)">Abrir Chat</button>
  <button class="submit-btn" onclick="clearPickerChat(1)">Borrar Chat</button>
</div>

<div class="picker-form" id="picker2Form">
  <h3>Picker 2</h3>
  <label>T√≠tulo</label><input id="picker2_title" type="text">
  <label>Mensaje gen√©rico</label><textarea id="picker2_msg" rows="2"></textarea>
  <label>Cuadrante
    <button class="add-btn" onclick="addPickerCuadrante(2)">A√±adir</button>
  </label>
  <div id="picker2_cuadrantes_container">
    <input type="text" class="picker_input">
    <select class="picker_priority">
      <option value="baja">Baja</option>
      <option value="media">Media</option>
      <option value="alta">Alta</option>
    </select>
  </div>
  <button class="submit-btn" onclick="goToPicker(2)">Ver Picker</button>
  <button class="submit-btn" onclick="openPickerChat(2)">Abrir Chat</button>
  <button class="submit-btn" onclick="clearPickerChat(2)">Borrar Chat</button>
</div>

<div class="picker-form" id="picker3Form">
  <h3>Picker 3</h3>
  <label>T√≠tulo</label><input id="picker3_title" type="text">
  <label>Mensaje gen√©rico</label><textarea id="picker3_msg" rows="2"></textarea>
  <label>Cuadrante
    <button class="add-btn" onclick="addPickerCuadrante(3)">A√±adir</button>
  </label>
  <div id="picker3_cuadrantes_container">
    <input type="text" class="picker_input">
    <select class="picker_priority">
      <option value="baja">Baja</option>
      <option value="media">Media</option>
      <option value="alta">Alta</option>
    </select>
  </div>
  <button class="submit-btn" onclick="goToPicker(3)">Ver Picker</button>
  <button class="submit-btn" onclick="openPickerChat(3)">Abrir Chat</button>
  <button class="submit-btn" onclick="clearPickerChat(3)">Borrar Chat</button>
</div>

<div class="picker-form" id="picker4Form">
  <h3>Picker 4</h3>
  <label>T√≠tulo</label><input id="picker4_title" type="text">
  <label>Mensaje gen√©rico</label><textarea id="picker4_msg" rows="2"></textarea>
  <label>Cuadrante
    <button class="add-btn" onclick="addPickerCuadrante(4)">A√±adir</button>
  </label>
  <div id="picker4_cuadrantes_container">
    <input type="text" class="picker_input">
    <select class="picker_priority">
      <option value="baja">Baja</option>
      <option value="media">Media</option>
      <option value="alta">Alta</option>
    </select>
  </div>
  <button class="submit-btn" onclick="goToPicker(4)">Ver Picker</button>
  <button class="submit-btn" onclick="openPickerChat(4)">Abrir Chat</button>
  <button class="submit-btn" onclick="clearPickerChat(4)">Borrar Chat</button>
</div>
</div>

</div>

<!-- CHAT MODAL HTML -->
<div id="chatModal">
  <div id="chatModalHeader">
    <span id="chatTitle">Chat Picker</span>
    <button onclick="closeChat()">X</button>
  </div>
  <div id="chatMessages"></div>
  <div id="chatInputContainer">
    <input id="chatInput" type="text" placeholder="Escribe un mensaje...">
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>

<script>
// --- VENTANAS ABIERTAS ---
const openPlantWindows = {};
const openPickerWindows = {};

// --- FUNCIONES PLANTAS ---
function addCuadrante(plantNum){
    const container = document.getElementById(`p${plantNum}_cuadrantes_container`);
    const wrapper = document.createElement('div');
    wrapper.style.display='flex'; wrapper.style.alignItems='center'; wrapper.style.marginBottom='4px';

    const input = document.createElement('input');
    input.type='text';
    input.placeholder='QU0000346545';
    input.className='cuadrante_input';

    const deleteBtn = document.createElement('button');
    deleteBtn.textContent='üóëÔ∏è';
    deleteBtn.style.marginLeft='5px';
    deleteBtn.onclick = () => wrapper.remove();

    wrapper.appendChild(input);
    wrapper.appendChild(deleteBtn);
    container.appendChild(wrapper);
}

function goToPlant(plantNum){
    const title = document.getElementById(`p${plantNum}_title`).value;
    const users = document.getElementById(`p${plantNum}_users`).value;
    const msg = document.getElementById(`p${plantNum}_msg`).value;
    const cuadrantes = Array.from(document.querySelectorAll(`#p${plantNum}_cuadrantes_container .cuadrante_input`))
        .map(i => i.value).filter(v => v);
    const data = { title, users, msg, cuadrantes };

    const plantUrls = { 1:'first.html', 2:'second.html', 3:'third.html' };
    const url = plantUrls[plantNum];
    if(!url){ alert('No se encontr√≥ la URL para esta planta.'); return; }

    if(openPlantWindows[plantNum] && !openPlantWindows[plantNum].closed){
        openPlantWindows[plantNum].postMessage({ type:'update', data }, '*');
    } else {
        openPlantWindows[plantNum] = window.open(`${url}?dummy=1`, '_blank');
        setTimeout(()=> {
            if(openPlantWindows[plantNum] && !openPlantWindows[plantNum].closed){
                openPlantWindows[plantNum].postMessage({ type:'update', data }, '*');
            }
        }, 500);
    }
}

// --- FUNCIONES PICKERS ---
function addPickerCuadrante(pickerNum){
    const container = document.getElementById(`picker${pickerNum}_cuadrantes_container`);
    const wrapper = document.createElement('div');
    wrapper.style.display='flex'; wrapper.style.alignItems='center'; wrapper.style.marginBottom='4px';

    const input = document.createElement('input'); 
    input.type='text'; 
    input.className='picker_input'; 
    input.placeholder='QU0000346545';

    const select = document.createElement('select'); 
    select.className='picker_priority';
    ['baja','media','alta'].forEach(p=>{ const opt=document.createElement('option'); opt.value=p; opt.text=p; select.appendChild(opt); });

    const deleteBtn = document.createElement('button');
    deleteBtn.textContent='üóëÔ∏è';
    deleteBtn.style.marginLeft='5px';
    deleteBtn.onclick = () => wrapper.remove();

    wrapper.appendChild(input);
    wrapper.appendChild(select);
    wrapper.appendChild(deleteBtn);
    container.appendChild(wrapper);
}

function goToPicker(pickerNum){
    const title = document.getElementById(`picker${pickerNum}_title`).value;
    const msg = document.getElementById(`picker${pickerNum}_msg`).value;
    const wrappers = document.querySelectorAll(`#picker${pickerNum}_cuadrantes_container > div`);
    const data = Array.from(wrappers).map(w => {
        const code = w.querySelector('.picker_input').value;
        const priority = w.querySelector('.picker_priority').value;
        return { code, priority };
    });

    // Actualizamos los datos
    const pickerData = { title, msg, data };

    // Revisamos si la ventana est√° abierta o no
    if(openPickerWindows[pickerNum] && !openPickerWindows[pickerNum].closed){
        openPickerWindows[pickerNum].postMessage({ type:'update', data: pickerData }, '*');
    } else {
        openPickerWindows[pickerNum] = window.open('picker.html', '_blank');
        setTimeout(() => {
            if(openPickerWindows[pickerNum] && !openPickerWindows[pickerNum].closed){
                openPickerWindows[pickerNum].postMessage({ type:'update', data: pickerData }, '*');
            }
        }, 500);
    }
}

// --- BORRAR CHAT DESDE INDEX ---
function clearPickerChat(pickerNum){
    // env√≠a mensaje a la ventana abierta para que haga limpieza local
    if(openPickerWindows[pickerNum] && !openPickerWindows[pickerNum].closed){
        openPickerWindows[pickerNum].postMessage({ type:'clearChat' }, '*');
    }
    // aqu√≠ tambi√©n puedes agregar c√≥digo para borrar chat en Firebase
    console.log(`Chat del Picker ${pickerNum} borrado desde index`);
}

// --- CHAT MODAL ---
let currentPickerChat = null;
let unsubscribe = null;
const notificationSound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

window.openPickerChat = function(pickerNum){
    currentPickerChat = pickerNum;
    document.getElementById('chatTitle').innerText = 'Chat Picker '+pickerNum;
    document.getElementById('chatModal').style.display='flex';
    loadMessages(); // tu funci√≥n de Firebase
}

window.closeChat = function(){
    document.getElementById('chatModal').style.display='none';
    document.getElementById('chatMessages').innerHTML='';
    if(unsubscribe){ unsubscribe(); unsubscribe=null; }
}

function notifyUser(title, body){
    if(Notification.permission==='granted'){
        new Notification(title,{body});
        notificationSound.play();
    }
}
</script>
</body>
</html>






