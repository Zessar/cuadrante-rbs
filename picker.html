<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Picker Autónomo</title>
<style>
body { font-family: Arial, sans-serif; background: #f4f4f9; padding: 12px; }
.container { max-width: 520px; margin: auto; background: white; padding: 14px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
h1 { text-align:center; margin-bottom:12px; font-size:1.1rem; }
.cuadrante-item { display:flex; justify-content:center; align-items:center; padding:12px; margin-bottom:8px; border-radius:6px; color:white; font-weight:600; cursor:pointer; user-select:none; }
.cuadrante-baja { background:#28a745; }
.cuadrante-media { background:#ffc107; color:black; }
.cuadrante-alta { background:#dc3545; }
#msgContainer { margin-top:10px; padding:10px; background:#e0e0e0; border-radius:6px; font-size:0.95rem; }
#openChatBtn { margin-top:14px; padding:10px 14px; background:#FF3A00; color:white; border:none; border-radius:6px; cursor:pointer; width:100%; font-weight:600; }
#chatModal { display:none; position:fixed; bottom:6%; right:5%; width:92%; max-width:420px; max-height:70%; background:white; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,0.18); z-index:1000; overflow:hidden; }
#chatModalHeader { background:#FF3A00; color:white; padding:10px; font-weight:bold; display:flex; justify-content:space-between; }
#chatMessages { padding:10px; height:280px; overflow-y:auto; background:#fafafa; }
#chatInputContainer { display:flex; padding:10px; border-top:1px solid #eee; }
#chatInput { flex:1; padding:8px; border-radius:6px; border:1px solid #ccc; }
#chatInputContainer button { margin-left:8px; padding:8px 12px; background:#FF3A00; color:white; border:none; border-radius:6px; cursor:pointer; }
@media(min-width:520px){
  .container{ padding:20px; }
  #chatModal{ width:380px; right:5%; bottom:5%; }
}
</style>
</head>
<body>
<div class="container">
  <h1 id="pickerTitle">Cuadrantes RBS</h1>
  <div id="cuadrantesContainer"></div>
  <div id="msgContainer"></div>

  <button id="openChatBtn">Abrir Chat</button>

  <!-- CHAT MODAL -->
  <div id="chatModal">
    <div id="chatModalHeader">
      <span id="chatTitle">Chat Picker</span>
      <button onclick="closeChat()">X</button>
    </div>
    <div id="chatMessages"></div>
    <div id="chatInputContainer">
      <input id="chatInput" type="text" placeholder="Escribe un mensaje..." />
      <button onclick="sendMessage()">Enviar</button>
    </div>
  </div>
</div>

<script>
/* ---------- render y manejo de postMessage ---------- */
function renderCuadrantes(cuadrantes = [], title = 'Cuadrantes RBS', msg = '') {
  document.getElementById('pickerTitle').textContent = title || 'Cuadrantes RBS';
  const container = document.getElementById('cuadrantesContainer');
  container.innerHTML = '';
  cuadrantes.forEach(c => {
    const div = document.createElement('div');
    const pr = c.priority || 'baja';
    div.className = 'cuadrante-item cuadrante-' + pr;
    div.textContent = c.code;
    div.onclick = () => {
      navigator.clipboard.writeText(c.code).then(() => {
        alert('✅ Cuadrante copiado: ' + c.code);
      }).catch(()=> {
        // fallback
        alert('Copiar: ' + c.code);
      });
    };
    container.appendChild(div);
  });
  document.getElementById('msgContainer').textContent = msg || '';
}

// initial empty
renderCuadrantes([], 'Cuadrantes RBS', '');

// state for picker id and firestore listener
let currentPickerNum = null;
let currentPickerId = null;
let unsubscribeChat = null;
let chatOpen = false;

window.addEventListener('message', (ev) => {
  // allow from same origin or '*' if needed; prefer origin check
  // If you host under different origin adjust this check.
  // For development allow all:
  // if(ev.origin !== location.origin) return;
  const payload = ev.data;
  if(!payload || !payload.type) return;
  if(payload.type === 'update') {
    const d = payload.data || payload;
    // d should contain pickerNum, title, msg, cuadrantes
    if(d.pickerNum) {
      currentPickerNum = d.pickerNum;
      currentPickerId = 'picker_' + d.pickerNum;
      // re-subscribe chat to right picker (handled below by subscribeChat)
      subscribeChatTo(currentPickerId);
    }
    const title = d.title || (d.data && d.data.title) || '';
    const msg = d.msg || (d.data && d.data.msg) || '';
    const cuadrantes = d.cuadrantes || (d.data && d.data.cuadrantes) || [];
    renderCuadrantes(cuadrantes, title, msg);
  } else if(payload.type === 'clearChat'){
    // clear local chat DOM only
    document.getElementById('chatMessages').innerHTML = '';
  }
});
</script>

<!-- FIREBASE CHAT (module) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCbh2FcoS3IK4wp4hXhX0NICGIDBbFQhGU",
  authDomain: "gestor-de-plantas.firebaseapp.com",
  projectId: "gestor-de-plantas",
  storageBucket: "gestor-de-plantas.firebasestorage.app",
  messagingSenderId: "653631965210",
  appId: "1:653631965210:web:82e503927c1064610be9a3",
  measurementId: "G-G7PN58F09R"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const notificationSound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
if(Notification.permission !== 'granted' && Notification.permission !== 'denied'){
  Notification.requestPermission();
}

// chat UI references
const chatModal = document.getElementById('chatModal');
const chatMessagesDiv = document.getElementById('chatMessages');
const openChatBtn = document.getElementById('openChatBtn');

openChatBtn.addEventListener('click', () => {
  chatModal.style.display = 'flex';
  chatOpen = true;
  chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
});

window.closeChat = () => { chatModal.style.display='none'; chatOpen=false; };

// subscribe helper
function subscribeChatTo(pickerId) {
  // unsubscribe previous
  if(window.__picker_unsub) {
    try { window.__picker_unsub(); } catch(e) {}
    window.__picker_unsub = null;
  }
  if(!pickerId) return;
  const messagesRef = collection(db, 'pickers', pickerId, 'chat');
  const q = query(messagesRef, orderBy('timestamp'));
  window.__picker_unsub = onSnapshot(q, snapshot => {
    chatMessagesDiv.innerHTML = '';
    snapshot.forEach(docSnap => {
      const msg = docSnap.data();
      const div = document.createElement('div');
      div.style.marginBottom = '6px';
      div.innerHTML = `<b>${msg.user}:</b> ${msg.text}`;
      chatMessagesDiv.appendChild(div);
    });
    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;

    // if new message and chat closed, show popup and notify
    if(snapshot.docs.length > 0 && !chatOpen) {
      const last = snapshot.docs[snapshot.docs.length - 1].data();
      if(last.user !== 'Gestor') {
        chatModal.style.display = 'flex';
        chatOpen = true;
        try { new Notification('Nuevo mensaje', { body: last.text }); } catch(e){}
        notificationSound.play();
      }
    }
  }, err => {
    console.error('picker chat onSnapshot error', err);
  });
}

// Expose subscribe to outer script that sets currentPickerId
window.subscribeChatTo = subscribeChatTo;

// send message as picker (this will make message appear in Firestore)
window.sendMessage = async function(){
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if(!text) return;
  if(!currentPickerId) {
    alert('Picker no identificado. Espera actualización desde el gestor.');
    return;
  }
  try {
    await addDoc(collection(db, 'pickers', currentPickerId, 'chat'), {
      user: currentPickerId,
      text,
      timestamp: serverTimestamp()
    });
    input.value = '';
  } catch(e){
    console.error('Error enviando mensaje desde picker:', e);
    alert('Error enviando mensaje. Mira consola.');
  }
};
</script>
</body>
</html>
