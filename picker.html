<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Picker Chat</title>
<style>
body { font-family: Arial; background:#f0f0f5; padding:20px; }
h2 { text-align:center; }
#chatContainer { border:1px solid #ccc; border-radius:10px; padding:10px; max-width:500px; margin:auto; background:white; }
#messages { height:300px; overflow-y:auto; border:1px solid #ddd; padding:5px; margin-bottom:10px; background:#fafafa; }
input { width:80%; padding:8px; border-radius:5px; border:1px solid #ccc; }
button { padding:8px 12px; border:none; border-radius:5px; background:#FF3A00; color:white; cursor:pointer; }
#cuadrantes { margin-bottom:10px; }
.cuadrante-item { margin-bottom:5px; }
</style>
</head>

<body>
<h2 id="pickerTitle">Picker</h2>
<div id="cuadrantes"></div>

<div id="chatContainer">
  <div id="messages"></div>
  <input type="text" id="chatInput" placeholder="Escribe un mensaje...">
  <button onclick="sendMessage()">Enviar</button>
</div>


<!-- Firebase (SDK modular) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// ------------------------------------------------------
// ðŸ”¥ CONFIGURACIÃ“N REAL DE TU FIREBASE
// ------------------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyCbh2FcoS3IK4wp4hXhX0NICGIDBbFQhGU",
  authDomain: "gestor-de-plantas.firebaseapp.com",
  projectId: "gestor-de-plantas",
  storageBucket: "gestor-de-plantas.firebasestorage.app",
  messagingSenderId: "653631965210",
  appId: "1:653631965210:web:82e503927c1064610be9a3",
  measurementId: "G-G7PN58F09R"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ------------------------------------------------------
// ðŸ”§ GET PARAMS
// ------------------------------------------------------
const urlParams = new URLSearchParams(window.location.search);
const pickerNum = urlParams.get('pickerNum') || "1";
document.getElementById("pickerTitle").innerText = "Picker " + pickerNum;

// ------------------------------------------------------
// ðŸ“¦ MOSTRAR CUADRANTES
// ------------------------------------------------------
const cuadrantesDiv = document.getElementById("cuadrantes");
const cuadrantesParam = urlParams.get("cuadrantes");

if (cuadrantesParam) {
  cuadrantesParam.split(",").forEach(c => {
    const d = document.createElement("div");
    d.className = "cuadrante-item";
    d.innerText = c;
    cuadrantesDiv.appendChild(d);
  });
}

// ------------------------------------------------------
// ðŸ’¬ CHAT (REAL TIME)
// ------------------------------------------------------
const messagesDiv = document.getElementById("messages");

const q = query(
  collection(db, "pickers_chat", "picker_" + pickerNum, "messages"),
  orderBy("timestamp")
);

onSnapshot(q, snapshot => {
  messagesDiv.innerHTML = "";
  snapshot.forEach(docSnap => {
    const msg = docSnap.data();
    const div = document.createElement("div");
    div.innerHTML = `<b>${msg.user}:</b> ${msg.text}`;
    messagesDiv.appendChild(div);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// ------------------------------------------------------
// ðŸš€ ENVIAR MENSAJE
// ------------------------------------------------------
window.sendMessage = async function sendMessage() {
  const input = document.getElementById("chatInput");
  const text = input.value.trim();
  if (!text) return;

  await addDoc(
    collection(db, "pickers_chat", "picker_" + pickerNum, "messages"),
    {
      user: "Picker " + pickerNum,
      text,
      timestamp: serverTimestamp()
    }
  );

  input.value = "";
};

// ------------------------------------------------------
// ðŸ”” NOTIFICACIONES (PEDIR PERMISO)
// ------------------------------------------------------
if (Notification.permission !== "granted") {
  Notification.requestPermission();
}
</script>

</body>
</html>
