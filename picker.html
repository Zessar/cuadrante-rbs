<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Picker Chat</title>

<style>
body { font-family: Arial; background:#f0f0f5; padding:20px; }
h2 { text-align:center; }

#chatContainer {
  border:1px solid #ccc; border-radius:10px; padding:10px;
  max-width:500px; margin:auto; background:white;
}

#messages {
  height:300px; overflow-y:auto; border:1px solid #ddd;
  padding:5px; margin-bottom:10px; background:#fafafa;
}

input {
  width:80%; padding:8px; border-radius:5px; border:1px solid #ccc;
}

button {
  padding:8px 12px; border:none; border-radius:5px;
  background:#FF3A00; color:white; cursor:pointer;
}

#cuadrantes { margin-bottom:10px; }
.cuadrante-item { margin-bottom:5px; }
</style>
</head>

<body>

<h2 id="pickerTitle">Picker</h2>
<div id="cuadrantes"></div>

<div id="chatContainer">
  <div id="messages"></div>
  <input type="text" id="chatInput" placeholder="Escribe un mensaje...">
  <button onclick="sendMessage()">Enviar</button>
</div>

<!-- Firebase compat (MISMO SDK QUE INDEX) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// -------------------------------------------
//  ðŸ”¥ MISMA CONFIG QUE index.html
// -------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyCbh2FcoS3IK4wp4hXhX0NICGIDBbFQhGU",
  authDomain: "gestor-de-plantas.firebaseapp.com",
  projectId: "gestor-de-plantas",
  storageBucket: "gestor-de-plantas.firebasestorage.app",
  messagingSenderId: "653631965210",
  appId: "1:653631965210:web:82e503927c1064610be9a3",
  measurementId: "G-G7PN58F09R"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Sonido
const notificationSound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

// -------------------------------------------
//  ðŸ”§ PARÃMETROS
// -------------------------------------------
const params = new URLSearchParams(window.location.search);
const pickerNum = params.get("pickerNum") || "1";

document.getElementById("pickerTitle").innerText = "Picker " + pickerNum;

// Mostrar cuadrantes
const cDiv = document.getElementById("cuadrantes");
const cuadrantesParam = params.get("cuadrantes");

if (cuadrantesParam) {
  cuadrantesParam.split(",").forEach(c => {
    const d = document.createElement("div");
    d.className = "cuadrante-item";
    d.innerText = c;
    cDiv.appendChild(d);
  });
}

// -------------------------------------------
//  ðŸ’¬ CHAT EN TIEMPO REAL
// -------------------------------------------
const messagesDiv = document.getElementById("messages");

db.collection("pickers_chat")
  .doc("picker_" + pickerNum)
  .collection("messages")
  .orderBy("timestamp")
  .onSnapshot(snapshot => {

    messagesDiv.innerHTML = "";

    snapshot.forEach(doc => {
      const msg = doc.data();
      const div = document.createElement("div");
      div.innerHTML = `<b>${msg.user}:</b> ${msg.text}`;
      messagesDiv.appendChild(div);
    });

    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    // NotificaciÃ³n si Ãºltimo mensaje NO es del picker
    if (snapshot.docs.length > 0) {
      const last = snapshot.docs[snapshot.docs.length - 1].data();
      if (last.user !== "Gestor") {
        if (Notification.permission === "granted") {
          new Notification(`Nuevo mensaje del Gestor`, { body: last.text });
          notificationSound.play();
        }
      }
    }

  });

// -------------------------------------------
//  ðŸš€ ENVIAR MENSAJE
// -------------------------------------------
function sendMessage(){
  const input = document.getElementById("chatInput");
  const text = input.value.trim();
  if (!text) return;

  db.collection("pickers_chat")
    .doc("picker_" + pickerNum)
    .collection("messages")
    .add({
      user: "Picker " + pickerNum,
      text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

  input.value = "";
}

// Solicitar permiso notificaciones
if (Notification.permission !== "granted") Notification.requestPermission();

</script>

</body>
</html>
