<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Picker Autónomo</title>
<style>
body { font-family: Arial, sans-serif; background: #f4f4f9; padding: 20px; }
.container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);}
h1 { text-align: center; margin-bottom: 20px; }
.cuadrante-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 6px; border-radius: 5px; color: white; font-weight: bold; }
.cuadrante-baja { background-color: #28a745; }
.cuadrante-media { background-color: #ffc107; color: black; }
.cuadrante-alta { background-color: #dc3545; }
button.copy-btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; background: #333; color: white; }
button.copy-btn:hover { background: #555; }

#chatContainer { margin-top: 20px; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; display:flex; flex-direction:column; height:300px; }
#chatMessages { flex:1; padding:10px; overflow-y:auto; background:#f9f9f9; }
#chatInputContainer { display:flex; border-top:1px solid #ddd; }
#chatInput { flex:1; padding:8px; border:none; }
#chatInputContainer button { padding:8px 12px; background:#FF3A00; color:white; border:none; cursor:pointer; }

#msgContainer { margin-top: 20px; padding: 10px; background: #e0e0e0; border-radius: 6px; }

@media (max-width: 600px) {
  .container { width: 95%; padding: 15px; }
  .cuadrante-item { flex-direction: column; align-items: flex-start; gap: 5px; }
}
</style>
</head>
<body>
<div class="container">
<h1 id="pickerTitle">Cuadrantes RBS</h1>
<div id="cuadrantesContainer"></div>
<div id="msgContainer"></div>

<div id="chatContainer">
  <div id="chatMessages"></div>
  <div id="chatInputContainer">
    <input id="chatInput" type="text" placeholder="Escribe un mensaje...">
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>
</div>

<script>
// Obtener parámetros de la URL
function getQueryParams() {
  const params = new URLSearchParams(window.location.search);
  const title = params.get('title') || 'Cuadrantes RBS';
  const msg = params.get('msg') || '';
  const rawCuadrantes = params.get('cuadrantes') || '';
  const cuadrantes = rawCuadrantes.split(',').map(c => {
    const [code, priority] = c.split('|');
    return { code, priority: priority || 'baja' };
  });
  return { title, msg, cuadrantes };
}

// Renderizar cuadrantes
function renderCuadrantes() {
  const { title, msg, cuadrantes } = getQueryParams();
  document.getElementById('pickerTitle').textContent = title;
  const container = document.getElementById('cuadrantesContainer');
  container.innerHTML = '';
  cuadrantes.forEach(c => {
    const div = document.createElement('div');
    div.className = 'cuadrante-item cuadrante-' + c.priority;
    const span = document.createElement('span');
    span.textContent = c.code;
    const btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.textContent = 'Copiar';
    btn.onclick = () => { navigator.clipboard.writeText(c.code); alert('✅ Cuadrante copiado: ' + c.code); };
    div.appendChild(span);
    div.appendChild(btn);
    container.appendChild(div);
  });
  const msgDiv = document.getElementById('msgContainer');
  msgDiv.textContent = msg;
}

renderCuadrantes();
</script>

<!-- FIREBASE CHAT -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCbh2FcoS3IK4wp4hXhX0NICGIDBbFQhGU",
    authDomain: "gestor-de-plantas.firebaseapp.com",
    projectId: "gestor-de-plantas",
    storageBucket: "gestor-de-plantas.firebasestorage.app",
    messagingSenderId: "653631965210",
    appId: "1:653631965210:web:82e503927c1064610be9a3",
    measurementId: "G-G7PN58F09R"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Identificar picker actual por URL
const pickerId = getQueryParams().title.replace(/\s+/g,'_');

// Cargar mensajes en tiempo real
const chatMessagesDiv = document.getElementById('chatMessages');
const messagesRef = collection(db,'pickers_chat','picker_'+pickerId,'messages');
const q = query(messagesRef, orderBy('timestamp'));
onSnapshot(q, snapshot=>{
  chatMessagesDiv.innerHTML='';
  snapshot.forEach(docSnap=>{
    const msg = docSnap.data();
    const div = document.createElement('div');
    div.style.marginBottom='6px';
    div.innerHTML=`<b>${msg.user}:</b> ${msg.text}`;
    chatMessagesDiv.appendChild(div);
  });
  chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
});

// Enviar mensaje
window.sendMessage = async function(){
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if(!text) return;
  await addDoc(messagesRef,{
    user: pickerId,
    text,
    timestamp: serverTimestamp()
  });
  input.value='';
}
</script>

</body>
</html>
